<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Keeta English Trainer — App-style</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --txt:#e5e7eb;
      --primary:#22c55e; --danger:#ef4444; --border:#1f2937; --gold:#facc15;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Tajawal,Cairo,sans-serif; padding-bottom: 70px; /* Space for mobile nav */}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b1220,#0b1220dd);border-bottom:1px solid var(--border);backdrop-filter:blur(4px);z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px;display:flex;gap:10px;align-items:center}
    .badge{padding:2px 8px;border-radius:999px;background:#14331f;color:#9ff7ba;border:1px solid #205d33;font-size:12px}
    
    /* --- MODIFIED: Desktop Grid --- */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){
      body { padding-bottom: 0; } /* No bottom padding on desktop */
      .grid{grid-template-columns: 320px 1fr}
    }

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .muted{color:var(--muted);font-size:13px}
    button{border:1px solid var(--border);background:#111827;color:var(--txt);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{background:var(--primary);color:#07120b;border-color:#0f5132;font-weight:700}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#0b1220;color:var(--txt)}
    .xp{display:flex;gap:10px;align-items:center}
    .progress{height:8px;background:#0b1220;border:1px solid var(--border);border-radius:8px;overflow:hidden}
    .bar{height:100%;background:var(--primary);width:0%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px dashed var(--border);padding:6px 10px;border-radius:999px}
    .q{font-size:18px;line-height:1.6}
    .choices{display:grid;gap:10px;margin-top:10px}
    .choice{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0b1220;cursor:pointer}
    .choice.correct{border-color:#14532d;background:#0b2415}
    .choice.wrong{border-color:#4b1a1a;background:#220d0d}
    .result{margin-top:10px;font-weight:700}
    .footer{opacity:.8;font-size:12px;text-align:center;margin:18px 0; display: none; /* Hidden, replaced by mobile nav */}
    .tag{font-size:12px;color:#9ca3af;border:1px solid var(--border);padding:2px 8px;border-radius:999px}
    .mode-tabs{display:flex;gap:8px;margin-bottom:8px}
    .hidden{display:none}
    .hint{font-size:12px;color:#93c5fd}
    .rtl{direction:rtl} .ltr{direction:ltr}
    
    .hover-word {
      cursor: help;
      text-decoration: underline dashed var(--muted);
      text-decoration-thickness: 1px;
    }
    
    .q-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #btnSpeak {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    
    /* --- NEW: Mobile App-like Bottom Nav --- */
    .mobile-nav {
      display: none; /* Hidden on desktop by default */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 65px;
      background: var(--card);
      border-top: 1px solid var(--border);
      justify-content: space-around;
      align-items: center;
      z-index: 10;
    }
    .mobile-nav button {
      background: none;
      border: none;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 10px;
    }
    .mobile-nav button .icon {
      font-size: 22px;
    }
    .mobile-nav button.active {
      color: var(--primary);
    }

    /* --- Mobile View Adjustments --- */
    @media (max-width: 899px) {
      .mobile-nav {
        display: flex; /* Show nav on mobile */
      }
      .grid {
        display: block; /* Stack panels on mobile */
      }
      /* Hide the original desktop mode tabs on mobile */
      #settingsPanel .mode-tabs {
        display: none;
      }
      /* Hide settings panel by default on mobile */
      #settingsPanel {
        display: none;
      }
    }
    
  </style>
</head>
<body>

<header>
  <div class="wrap row">
    <h1>Keeta English Trainer <span class="badge">Daily XP</span></h1>
    <div class="row" style="margin-inline-start:auto">
      <div class="pill">⭐ XP: <span id="xp">0</span></div>
      <div class="pill">🔥 Streak: <span id="streak">0</span> days</div>
    </div>
  </div>
</header>

<div class="wrap grid">
  <aside class="card" id="settingsPanel">
    <div class="mode-tabs">
      <button class="primary" id="btnDaily">الدرس اليومي</button>
      <button id="btnReview">مراجعة</button>
    </div>
    <div class="row">
      <div class="progress" style="flex:1"><div id="bar" class="bar"></div></div>
      <span class="muted" id="goalText">0/20 XP</span>
    </div>
    <hr style="border-color:#1f2937">
    <div class="muted">اللغة:</div>
    <div class="row">
      <select id="uiLang">
        <option value="ar">واجهة: عربي</option>
        <option value="en">واجهة: English</option>
      </select>
      <select id="exerciseLang">
        <option value="both">تمارين: عربي ↔ إنجليزي</option>
        <option value="en2ar">إنجليزي → عربي</option>
        <option value="ar2en">عربي → إنجليزي</option>
      </select>
    </div>
    <div class="muted" style="margin-top:8px">الفئات:</div>
    <div id="cats" class="row"></div>
    <hr style="border-color:#1f2937">
    <div class="muted">نصائح:</div>
    <ul class="muted">
      <li>**جديد:** تم زيادة عدد التمارين إلى 10,000 تمرين.</li>
      <li>الصوت لا يعمل إلا بالضغط على 🔊.</li>
      <li>قف بالماوس على أي كلمة لترجمة *الكلمة* (لو موجودة بالقاموس).</li>
      <li>تم التركيز على أسئلة الكتابة (80% من الأسئلة).</li>
    </ul>
  </aside>

  <main class="card" id="mainPanel">
    <div id="screenLesson">
      <div class="tag" id="catTag"></div>
      
      <div class="q-container">
        <button id="btnSpeak" title="نطق">🔊</button>
        <div class="q" id="question">اضغط ابدأ لبدء الدرس</div>
      </div>
      
      <div class="hint" id="hint"></div>
      <div id="mc" class="choices hidden"></div>
      <div id="typing" class="hidden">
        <input id="answer" placeholder="اكتب الترجمة هنا…">
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnStart" class="primary">ابدأ</button>
        <button id="btnCheck">تحقق</button>
        <button id="btnSkip" class="ghost">تخطي</button>
        <button id="btnHint" class="ghost">تلميح</button>
      </div>
      <div id="result" class="result"></div>
    </div>

    <div id="screenReview" class="hidden">
      <h3>مراجعة الأخطاء</h3>
      <div id="revList"></div>
      <button id="btnPracticeWrong" class="primary">تدريب على الأخطاء</button>
    </div>
  </main>
</div>

<nav class="mobile-nav" id="mobileNav">
  <button class="active" data-tab="lesson">
    <span class="icon">📚</span>
    <span>الدرس</span>
  </button>
  <button data-tab="review">
    <span class="icon">🔄</span>
    <span>مراجعة</span>
  </button>
  <button data-tab="settings">
    <span class="icon">⚙️</span>
    <span>الإعدادات</span>
  </button>
</nav>


<script>
// ===== NEW: Mini-Dictionary =====
const MINI_DICT_EN_AR = {
  "please": "من فضلك", "confirm": "يؤكد", "complete": "يكمل", "delivery": "توصيل",
  "kindly": "من فضلك", "share": "يشارك", "location": "موقع", "start": "يبدأ",
  "shift": "شيفت", "on": "في", "time": "وقت", "rider": "سائق", "lost": "فقد",
  "validity": "صلاحية", "due": "بسبب", "system": "نظام", "delay": "تأخير",
  "order": "طلب", "restaurant": "مطعم", "issue": "مشكلة", "bike": "دراجة",
  "broke": "تعطلت", "down": " ", "performance": "أداء", "company": "شركة",
  "dropped": "انخفض", "low": "منخفض", "rate": "معدل", "need": "يحتاج",
  "increase": "يزيد", "valid": "صالح", "days": "أيام", "reach": "يصل", "level": "مستوى",
  "motivate": "يحفز", "riders": "السائقين", "improve": "يحسن", "find": "يجد",
  "attached": "مرفق", "report": "تقرير", "updated": "محدث", "list": "قائمة",
  "thank": "شكرا", "you": "لك", "quick": "سريع", "response": "رد", "my": "لي",
  "opinion": "رأي", "should": "يجب", "focus": "نركز", "clarify": "يوضح",
  "part": "جزء", "let's": "دعنا", "review": "نراجع", "weekly": "أسبوعي",
  "great": "عظيم", "effort": "مجهود", "today": "اليوم", "keep": "استمر", "up": " ",
  "improvement": "تحسن", "visible": "واضح", "believe": "نعتقد", "target": "هدف",
  "follow": "يتبع", "rules": "قواعد", "every": "كل", "booked": "محجوز",
  "must": "يجب", "completed": "مكتمل", "repeated": "متكرر", "rejections": "رفض",
  "will": "سوف", "affect": "يؤثر", "invoice": "فاتورة", "your": "لك",
  "long": "طويل", "breaks": "استراحات", "during": "خلال", "peak": "ذروة",
  "customer": "عميل", "answer": "يرد", "phone": "هاتف", "changed": "غير",
  "app": "تطبيق", "was": "كان", "responding": "يستجيب", "minutes": "دقائق",
  "received": "استلمنا", "message": "رسالة", "opened": "فتحنا", "immediately": "فورا",
  "marked": "علم", "invalid": "غير صالح", "mistake": "خطأ", "stuck": "عالق",
  "traffic": "زحام", "remove": "يزيل", "penalty": "مخالفة", "fault": "خطأ",
  "targeting": "نستهدف", "month": "شهر", "file": "ملف", "link": "رابط",
  "below": "أدناه", "solutions": "حلول", "blame": "لوم", "give": "يستسلم",
  "close": "قريب", "consistency": "استمرارية", "key": "مفتاح", "success": "نجاح",
  "four": "أربعة", "status": "حالة", "avoid": "يتجنب", "unnecessary": "غير ضروري",
  "book": "يحجز", "realistic": "واقعي", "total": "إجمالي", "online": "متصل",
  "hours": "ساعات", "exceed": "يتجاوز", "without": "بدون", "call": "يتصل",
  "before": "قبل", "marking": "تعليم", "delayed": "متأخر", "informed": "أبلغنا",
  "service": "خدمة", "case": "حالة", "escalate": "يصعد", "support": "دعم",
  "team": "فريق", "quiz": "اختبار", "page": "صفحة", "loaded": "تحميل", "late": "متأخر",
  "assessment": "تقييم", "published": "ينشر", "sunday": "الأحد", "analyze": "يحلل",
  "root": "جذري", "cause": "سبب", "failures": "إخفاقات", "all": "كل",
  "wear": "يرتدي", "official": "رسمي", "uniform": "زي", "provided": "قدم",
  "wrong": "خاطئ", "pin": "موقع", "positive": "إيجابي", "attitude": "موقف",
  "appreciated": "مقدر", "what": "ماذا", "action": "خطة", "plan": "عمل",
  "quarter": "ربع", "average": "متوسط", "server": "خادم", "maintenance": "صيانة",
  "requests": "يطلب", "contactless": "بدون تلامس", "share": "يشارك", "information": "معلومات",
  "anyone": "أي شخص", "create": "ينشئ", "new": "جديد", "courier": "سائق",
  "correct": "صحيح", "branch": "فرع", "group": "مجموعة", "upload": "يرفع",
  "mandatory": "إلزامي", "compliance": "التزام", "documents": "مستندات", "select": "يختار",
  "vehicle": "مركبة", "type": "نوع", "motorcycle": "دراجة نارية", "car": "سيارة"
};
const MINI_DICT_AR_EN = {
  "من": "from", "فضلك": "please", "يؤكد": "confirm", "يكمل": "complete", "توصيل": "delivery",
  "يشارك": "share", "موقع": "location", "يبدأ": "start", "شيفت": "shift", "في": "in/on",
  "وقت": "time", "سائق": "rider", "فقد": "lost", "صلاحية": "validity", "بسبب": "due to",
  "نظام": "system", "تأخير": "delay", "طلب": "order", "مطعم": "restaurant", "مشكلة": "issue",
  "دراجة": "bike", "تعطلت": "broke down", "أداء": "performance", "شركة": "company",
  "انخفض": "dropped", "منخفض": "low", "معدل": "rate", "يحتاج": "need", "يزيد": "increase",
  "صالح": "valid", "أيام": "days", "يصل": "reach", "مستوى": "level", "يحفز": "motivate",
  "السائقين": "riders", "يحسن": "improve", "يجد": "find", "مرفق": "attached",
  "تقرير": "report", "محدث": "updated", "قائمة": "list", "شكرا": "thank you", "سريع": "quick",
  "رد": "response", "رأي": "opinion", "يجب": "must/should", "نركز": "focus",
  "يوضح": "clarify", "جزء": "part", "دعنا": "let's", "نراجع": "review", "أسبوعي": "weekly",
  "عظيم": "great", "مجهود": "effort", "اليوم": "today", "استمر": "keep it up", "تحسن": "improvement",
  "واضح": "visible", "نعتقد": "believe", "هدف": "target", "يتبع": "follow", "قواعد": "rules",
  "كل": "every", "محجوز": "booked", "مكتمل": "completed", "متكرر": "repeated",
  "رفض": "rejections", "سوف": "will", "يؤثر": "affect", "فاتورة": "invoice",
  "طويل": "long", "استراحات": "breaks", "خلال": "during", "ذروة": "peak", "عميل": "customer",
  "يرد": "answer", "هاتف": "phone", "غير": "changed/invalid", "تطبيق": "app", "كان": "was",
  "يستجيب": "responding", "دقائق": "minutes", "استلمنا": "received", "رسالة": "message",
  "فتحنا": "opened", "فورا": "immediately", "علم": "marked", "خطأ": "mistake/fault",
  "عالق": "stuck", "زحام": "traffic", "يزيل": "remove", "مخالفة": "penalty",
  "نستهدف": "targeting", "شهر": "month", "ملف": "file", "رابط": "link", "أدناه": "below",
  "حلول": "solutions", "لوم": "blame", "يستسلم": "give up", "قريب": "close",
  "استمرارية": "consistency", "مفتاح": "key", "نجاح": "success", "أربعة": "four",
  "حالة": "status/case", "يتجنب": "avoid", "ضروري": "necessary", "يحجز": "book",
  "واقعي": "realistic", "إجمالي": "total", "متصل": "online", "ساعات": "hours",
  "يتجاوز": "exceed", "بدون": "without", "يتصل": "call", "قبل": "before",
  "تعليم": "marking", "متأخر": "delayed", "أبلغنا": "informed", "خدمة": "service",
  "يصعد": "escalate", "دعم": "support", "فريق": "team", "اختبار": "quiz",
  "صفحة": "page", "تحميل": "loaded", "تقييم": "assessment", "ينشر": "published",
  "الأحد": "Sunday", "يحلل": "analyze", "جذري": "root", "سبب": "cause",
  "إخفاقات": "failures", "يرتدي": "wear", "رسمي": "official", "زي": "uniform",
  "قدم": "provided", "خاطئ": "wrong", "إيجابي": "positive", "موقف": "attitude",
  "مقدر": "appreciated", "ماذا": "what", "خطة": "plan", "عمل": "action",
  "ربع": "quarter", "متوسط": "average", "خادم": "server", "صيانة": "maintenance",
  "يطلب": "requests", "تلامس": "contactless", "معلومات": "information", "شخص": "anyone",
  "ينشئ": "create", "جديد": "new", "صحيح": "correct", "فرع": "branch",
  "مجموعة": "group", "يرفع": "upload", "إلزامي": "mandatory", "التزام": "compliance",
  "مستندات": "documents", "يختار": "select", "مركبة": "vehicle", "نوع": "type",
  "نارية": "motorcycle", "سيارة": "car"
};

// ===== DATA (You can extend easily) =====
const DATA = [
  {cat:"Daily Communication", en:"Please confirm once you complete your delivery.", ar:"يرجى التأكيد بعد إتمام عملية التوصيل."},
  {cat:"Daily Communication", en:"Kindly share your location.", ar:"من فضلك شارك موقعك."},
  {cat:"Daily Communication", en:"Start your shift on time.", ar:"ابدأ الشيفت في الوقت المحدد."},
  {cat:"Reporting & Issues", en:"The rider lost validity due to a system delay.", ar:"السائق فقد يوم صالح بسبب تأخير من النظام."},
  {cat:"Reporting & Issues", en:"The order was delayed due to a restaurant issue.", ar:"تم تأخير الطلب بسبب مشكلة من المطعم."},
  {cat:"Reporting & Issues", en:"The bike broke down during the delivery.", ar:"تعطلت الدراجة أثناء التوصيل."},
  {cat:"Performance", en:"The company performance dropped because of low on-time rate.", ar:"انخفض أداء الشركة بسبب ضعف الالتزام بالوقت."},
  {cat:"Performance", en:"We need to increase valid days to reach level A.", ar:"نحتاج إلى زيادة الأيام الصالحة للوصول إلى المستوى A."},
  {cat:"Performance", en:"Please motivate your riders to improve their on-time rate.", ar:"يرجى تحفيز السائقين لتحسين نسبة الالتزام بالوقت."},
  {cat:"WhatsApp", en:"Please find the attached performance report.", ar:"يرجى مراجعة تقرير الأداء المرفق."},
  {cat:"WhatsApp", en:"Kindly share the updated rider list.", ar:"من فضلك شارك قائمة السائقين المحدثة."},
  {cat:"WhatsApp", en:"Thank you for your quick response.", ar:"شكرًا على ردك السريع."},
  {cat:"Meetings", en:"In my opinion, we should focus on valid days.", ar:"برأيي، يجب أن نركز على الأيام الصالحة."},
  {cat:"Meetings", en:"Could you please clarify this part?", ar:"هل يمكنك توضيح هذا الجزء من فضلك؟"},
  {cat:"Meetings", en:"Let’s review the weekly report together.", ar:"دعونا نراجع التقرير الأسبوعي معًا."},
  {cat:"Motivation", en:"Great effort today, keep it up!", ar:"مجهود رائع اليوم، استمر!"},
  {cat:"Motivation", en:"Your improvement this week is visible.", ar:"تحسنك هذا الأسبوع واضح."},
  {cat:"Motivation", en:"We believe you can reach the target.", ar:"نثق أنك تستطيع الوصول للهدف."},
  {cat:"Compliance", en:"Please follow the company rules.", ar:"يرجى الالتزام بقواعد الشركة."},
  {cat:"Compliance", en:"Every booked shift must be completed.", ar:"كل شيفت محجوز يجب إكماله."},
  {cat:"Compliance", en:"Repeated rejections will affect your invoice.", ar:"تكرار الرفض سيؤثر على فاتورتك."},
  {cat:"Shifts", en:"Your shift starts at 10 AM.", ar:"شيفتك يبدأ الساعة 10 صباحًا."},
  {cat:"Shifts", en:"Do not take long breaks during peak time.", ar:"لا تأخذ فترات راحة طويلة خلال أوقات الذروة."},
  {cat:"Shifts", en:"Please clock in and clock out properly.", ar:"يرجى تسجيل الدخول والخروج بشكل صحيح."},
  {cat:"Customer", en:"The customer did not answer the phone.", ar:"العميل لم يرد على الهاتف."},
  {cat:"Customer", en:"The customer changed the location.", ar:"العميل غيّر الموقع."},
  {cat:"Customer", en:"The customer delayed receiving the order.", ar:"تأخر العميل في استلام الطلب."},
  {cat:"System", en:"The app was not responding for a few minutes.", ar:"التطبيق لم يستجب لبضع دقائق."},
  {cat:"System", en:"We received a Core message and opened it immediately.", ar:"استلمنا رسالة Core وفتحناها فورًا."},
  {cat:"System", en:"The system marked the day invalid by mistake.", ar:"النظام سجّل اليوم كغير صالح عن طريق الخطأ."},
];

// --- ADDED: Keeta-specific sentences ---
const EXTRA_IMPORT = [{"cat": "Keeta", "en": "Create a new courier with the correct branch and group.", "ar": "أنشئ سائقًا جديدًا مع اختيار الفرع والمجموعة بشكل صحيح."}, {"cat": "Keeta", "en": "Upload all mandatory compliance documents.", "ar": "قم برفع جميع مستندات الالتزام الإلزامية."}, {"cat": "Keeta", "en": "Select the vehicle type: motorcycle or car.", "ar": "اختر نوع المركبة: دراجة نارية أو سيارة."}, {"cat": "Keeta", "en": "Use Live Monitoring for day-on-day and week-on-week comparisons.", "ar": "استخدم المراقبة المباشرة للمقارنة اليومية والأسبوعية."}, {"cat": "Keeta", "en": "Download data reports by selecting specific dates.", "ar": "حمّل تقارير البيانات باختيار تواريخ محددة."}, {"cat": "Keeta", "en": "Use Real-time Courier Monitor to track riders by order or by courier.", "ar": "استخدم مراقبة السائقين اللحظية لتتبع السائقين حسب الطلب أو حسب السائق."}, {"cat": "Keeta", "en": "Check status changes and task progress in real time.", "ar": "تحقق من تغيّر الحالات وتقدّم المهام في الوقت الفعلي."}, {"cat": "Keeta", "en": "Open the Order Center to view complete order details.", "ar": "افتح مركز الطلبات لمراجعة تفاصيل الطلب كاملة."}, {"cat": "Keeta", "en": "Click 'view' to see the full delivery flow.", "ar": "اضغط \"عرض\" لرؤية مسار التوصيل بالكامل."}, {"cat": "Keeta", "en": "Use the Violation Center to track penalties and appeals.", "ar": "استخدم مركز المخالفات لتتبع الجزاءات والتظلمات."}, {"cat": "Keeta", "en": "Open the penalty details to review evidence and status.", "ar": "افتح تفاصيل المخالفة لمراجعة الأدلة والحالة."}, {"cat": "Keeta", "en": "Check Penalty Management for all active deductions.", "ar": "افحص إدارة الجزاءات لكل الخصومات الفعّالة."}, {"cat": "Keeta", "en": "Go to Financial Management to review billing details.", "ar": "اذهب إلى إدارة المالية لمراجعة تفاصيل الفواتير."}, {"cat": "Keeta", "en": "Download the bill breakdown by rider and by order.", "ar": "قم بتنزيل تفصيل الفاتورة حسب السائق وحسب الطلب."}, {"cat": "Keeta", "en": "Use the standard template to create a tax invoice.", "ar": "استخدم القالب القياسي لإنشاء فاتورة ضريبية."}, {"cat": "Keeta", "en": "Confirm the bill before uploading the invoice.", "ar": "قم بتأكيد الفاتورة قبل رفع الإيصال."}, {"cat": "Keeta", "en": "Open Payment Details to view payment dates and balances.", "ar": "افتح تفاصيل المدفوعات لمراجعة تواريخ الدفع والأرصدة."}, {"cat": "Keeta", "en": "Add supervisors under Staff Management → Operation Staff.", "ar": "أضف المشرفين من إدارة الموظفين ← طاقم التشغيل."}, {"cat": "Keeta", "en": "Create a Supervisor Group and assign positions.", "ar": "أنشئ مجموعة مشرفين وحدد الوظائف."}, {"cat": "Keeta", "en": "Check assessment plans and progress in Incentive Management.", "ar": "راجع خطط التقييم والتقدم في إدارة الحوافز."}, {"cat": "Keeta", "en": "Targets and weights will be announced monthly.", "ar": "سيتم إعلان الأهداف والأوزان شهريًا."}, {"cat": "Keeta", "en": "Check the Message Center for internal notifications.", "ar": "افحص مركز الرسائل للإشعارات الداخلية."}, {"cat": "Keeta", "en": "Log in 15 minutes before your shift starts.", "ar": "سجّل الدخول قبل بداية شيفتك بـ 15 دقيقة."}, {"cat": "Keeta", "en": "Log out 15 minutes after your shift ends.", "ar": "سجّل الخروج بعد نهاية الشيفت بـ 15 دقيقة."}, {"cat": "Keeta", "en": "Use your registered phone or email to log in to the partner platform.", "ar": "استخدم هاتفك المسجل أو البريد الإلكتروني لتسجيل الدخول إلى منصة الشركاء."}, {"cat": "Keeta", "en": "Book shifts weekly on Wednesday at 4:00 PM.", "ar": "احجز الشيفتات أسبوعيًا يوم الأربعاء الساعة 4:00 مساءً."}, {"cat": "Keeta", "en": "Cancel shifts 72 hours before the start time.", "ar": "ألغِ الشيفت قبل بدايته بـ 72 ساعة."}, {"cat": "Keeta", "en": "Choose your primary zone first; secondary zones if full.", "ar": "اختر منطقتك الأساسية أولًا؛ والثانوية إذا امتلأت."}, {"cat": "Keeta", "en": "Stay within your zone during shifts; return quickly if you go out.", "ar": "ابق داخل منطقتك أثناء الشيفت؛ وارجع بسرعة إذا خرجت."}, {"cat": "Keeta", "en": "You will be logged off after 25 minutes outside the zone.", "ar": "سيتم تسجيل خروجك تلقائيًا بعد 25 دقيقة خارج المنطقة."}, {"cat":"Keeta", "en": "Use up to 10% of your shift as break time.", "ar": "يمكنك استخدام حتى 10٪ من الشيفت كوقت استراحة."}, {"cat": "Keeta", "en": "Keep online at least 90% of the booked time.", "ar": "ابقَ متصلًا على الأقل 90٪ من وقت الشيفت المحجوز."}, {"cat": "Keeta", "en": "Green tick means good attendance performance.", "ar": "العلامة الخضراء تعني أداء حضور جيد."}, {"cat": "Keeta", "en": "Tap 'Arrived at Restaurant' when you reach the store.", "ar": "اضغط \"وصلت للمطعم\" عند وصولك للمطعم."}, {"cat": "Keeta", "en": "Tap 'Pick Up' after receiving the order.", "ar": "اضغط \"استلام\" بعد استلام الطلب."}, {"cat": "Keeta", "en": "Tap 'Confirm Drop Off' and upload a proof photo.", "ar": "اضغط \"تأكيد التسليم\" وارفع صورة إثبات."}, {"cat": "Keeta", "en": "Use in-app chat to contact the customer; messages stay for 48 hours.", "ar": "استخدم محادثة التطبيق للتواصل مع العميل؛ الرسائل تبقى 48 ساعة."}, {"cat": "Keeta", "en": "Share your pin location to coordinate easily.", "ar": "شارك موقعك لتسهيل التنسيق."}, {"cat": "Keeta", "en": "Report abnormal situations via the Abnormal Report feature.", "ar": "أبلغ عن الحالات غير الطبيعية عبر ميزة التقرير غير العادي."}, {"cat": "Keeta", "en": "Appeals must be submitted within 48 hours of the penalty notice.", "ar": "يجب تقديم التظلّم خلال 48 ساعة من إشعار المخالفة."}];
EXTRA_IMPORT.forEach(x=>DATA.push(x));
// --- End of added data ---


// Add many more items quickly:
const EXTRA = [
  ["Reporting & Issues","The rider was stuck due to traffic.","تعطل السائق بسبب الزحام."],
  ["Reporting & Issues","Please remove this penalty; it was not the rider's fault.","يرجى إزالة هذه المخالفة؛ لم تكن خطأ السائق."],
  ["Performance","We are targeting level A this month.","نستهدف المستوى A هذا الشهر."],
  ["Performance","Our on-time rate needs improvement.","نسبة الالتزام بالوقت لدينا تحتاج لتحسين."],
  ["WhatsApp","I have shared the file link below.","قمت بمشاركة رابط الملف أدناه."],
  ["WhatsApp","Please update the attendance record.","يرجى تحديث سجل الحضور."],
  ["Meetings","Let's focus on solutions, not blame.","دعونا نركز على الحلول لا على اللوم."],
  ["Meetings","We will align with Keeta's rules.","سنلتزم بقواعد كيتا."],
  ["Motivation","Don't give up, you are close to the target.","لا تستسلم، أنت قريب من الهدف."],
  ["Motivation","Your consistency is the key to success.","الاستمرارية هي مفتاح النجاح."],
  ["Compliance","Four invalid days will affect your status.","أربعة أيام غير صالحة ستؤثر على وضعك."],
  ["Compliance","Please avoid unnecessary rejections.","يرجى تجنب الرفض غير الضروري."],
  ["Shifts","Book realistic shifts and complete them.","احجز شيفتات واقعية وأكملها."],
  ["Shifts","Total online hours must exceed 10 without breaks.","يجب أن تتجاوز الساعات المتصلة 10 بدون فواصل."],
  ["Customer","Please call the customer before marking delayed.","يرجى الاتصال بالعميل قبل وضع تأخير."],
  ["Customer","We informed the customer service about this case.","قمنا بإبلاغ خدمة العملاء عن هذه الحالة."],
  ["System","We will escalate this issue to the support team.","سنصعد هذه المشكلة إلى فريق الدعم."],
  ["System","The quiz page loaded late due to system delay.","صفحة الاختبار تأخرت في التحميل بسبب النظام."],
  // --- NEWLY ADDED SENTENCES ---
  ["Performance", "The weekly assessment will be published on Sunday.", "سيتم نشر التقييم الأسبوعي يوم الأحد."],
  ["Performance", "We need to analyze the root cause of the failures.", "نحتاج إلى تحليل السبب الجذري للإخفاقات."],
  ["Compliance", "All riders must wear the official uniform.", "يجب على جميع السائقين ارتداء الزي الرسمي."],
  ["Reporting & Issues", "The customer provided the wrong PIN location.", "العميل أدخل موقع PIN خاطئ."],
  ["Motivation", "Your positive attitude is appreciated.", "نقدر موقفك الإيجابي."],
  ["Meetings", "What is the action plan for this quarter?", "ما هي خطة العمل لهذا الربع؟"],
  ["Performance", "Average delivery time has improved by 10%.", "تحسن متوسط وقت التوصيل بنسبة 10٪."],
  ["System", "The server is down for maintenance.", "الخادم متوقف للصيانة."],
  ["Customer", "The customer requests a contactless delivery.", "العميل يطلب توصيل بدون تلامس."],
  ["Compliance", "Do not share customer information with anyone.", "لا تشارك معلومات العميل مع أي شخص."]
];
EXTRA.forEach(([cat,en,ar])=>DATA.push({cat,en,ar}));

// --- NEW: Create 10,000+ exercise pool ---
const uniqueSentences = DATA.slice(); // Copy all unique sentences (around 150+)
const numUnique = uniqueSentences.length;
while(DATA.length < 10000) { // Target 10,000
  DATA.push(uniqueSentences[DATA.length % numUnique]); 
}
// ---

const CATS = ["All", ...[...new Set(uniqueSentences.map(x=>x.cat))]]; // Categories from unique sentences

// ===== STATE =====
const LS = (k,v)=> v===undefined ? JSON.parse(localStorage.getItem(k)||"null") : localStorage.setItem(k,JSON.stringify(v));
const state = {
  idx:0, order:[], mode:"daily", xp: LS("xp") ?? 0,
  streak: LS("streak") ?? 0, lastDay: LS("lastDay") ?? null, wrong: LS("wrong") ?? [],
  goal:20, ui:"ar", exMode: "both", cat: "All",
  currentQuestionText: "", // For re-speaking
  currentLang: "" // For re-speaking
};

// ===== INIT UI =====
const el = id=>document.getElementById(id);
const xpEl = el("xp"), streakEl = el("streak"), barEl = el("bar"), goalText = el("goalText");
const btnStart = el("btnStart"), btnCheck = el("btnCheck"), btnSkip = el("btnSkip"), btnHint = el("btnHint"), btnSpeak = el("btnSpeak");
const qEl = el("question"), mcEl = el("mc"), typingEl = el("typing"), ansEl = el("answer"), resEl = el("result"), hintEl = el("hint");
const btnDaily = el("btnDaily"), btnReview = el("btnReview"), screenLesson = el("screenLesson"), screenReview = el("screenReview");
const uiLang = el("uiLang"), exerciseLang = el("exerciseLang"), catTag = el("catTag"), catsDiv = el("cats");

// --- NEW: Mobile Nav Elements ---
const mobileNav = el("mobileNav");
const mainPanel = el("mainPanel");
const settingsPanel = el("settingsPanel");
const mobileNavButtons = mobileNav.querySelectorAll("button");
// ===================================

// ===== Speech Synthesis =====
const synth = window.speechSynthesis;
let voices = [];
function populateVoices(){
  voices = synth.getVoices();
}
populateVoices();
if (synth.onvoiceschanged !== undefined) {
  synth.onvoiceschanged = populateVoices;
}
function speak(text, langCode){
  if (synth.speaking) {
    synth.cancel(); // Stop any previous speech
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = langCode;
  
  let voice = voices.find(v => v.lang === langCode);
  if(langCode === 'en-US' && !voice) {
    voice = voices.find(v => v.lang.startsWith('en-')); // Fallback for English
  }
  if(langCode === 'ar-SA' && !voice) {
    voice = voices.find(v => v.lang.startsWith('ar-')); // Fallback for Arabic
  }
  
  utter.voice = voice;
  synth.speak(utter);
}
btnSpeak.onclick = () => {
  if (state.currentQuestionText) {
    speak(state.currentQuestionText, state.currentLang);
  }
};
// ===================================


function updateHeader(){
  xpEl.textContent = state.xp;
  streakEl.textContent = state.streak;
  const progress = Math.min(100, Math.round((state.xp%state.goal)/state.goal*100));
  barEl.style.width = progress+"%";
  goalText.textContent = `${state.xp%state.goal}/${state.goal} XP`;
  LS("xp",state.xp); LS("streak",state.streak);
}

function ensureStreak(){
  const today = new Date().toISOString().slice(0,10);
  if(state.lastDay!==today){
    const prev = state.lastDay;
    if(prev){
      const d1 = new Date(prev), d2 = new Date(today);
      const diff = (d2 - d1)/86400000;
      if(diff===1) state.streak += 1;
      else state.streak = 1;
    }else{
      state.streak = 1;
    }
    state.lastDay = today;
    LS("lastDay",state.lastDay); LS("streak",state.streak);
  }
}

function saveWrong(pair, dir){
  state.wrong.push({pair, dir, time: Date.now()});
  if(state.wrong.length>50) state.wrong.shift();
  LS("wrong",state.wrong);
}

function renderWrongList(){
  const box = el("revList");
  if(state.wrong.length===0){ box.innerHTML = "<div class='muted'>لا توجد أخطاء حتى الآن.</div>"; return; }
  box.innerHTML = state.wrong.slice(-20).reverse().map(w=>{
    const q = w.dir==="en2ar"? w.pair.en : w.pair.ar;
    const a = w.dir==="en2ar"? w.pair.ar : w.pair.en;
    return `<div class='card' style="margin:8px 0"><div class='muted'>سؤال</div><div>${q}</div><div class='muted'>الإجابة</div><div>${a}</div></div>`
  }).join("");
}

// --- MODIFIED: setMode now just handles the screens *inside* mainPanel ---
function setMode(m){
  state.mode = m;
  if(m==="daily"){
    screenLesson.classList.remove("hidden");
    screenReview.classList.add("hidden");
  } else {
    screenLesson.classList.add("hidden");
    screenReview.classList.remove("hidden");
    renderWrongList();
  }
  // Desktop buttons
  btnDaily.classList.toggle("primary", m==="daily");
  btnReview.classList.toggle("primary", m==="review");
}
btnDaily.onclick=()=>setMode("daily");
btnReview.onclick=()=>setMode("review");

// --- NEW: Mobile Tab Navigation ---
function setMobileTab(tab) {
  mobileNavButtons.forEach(btn => {
    btn.classList.toggle("active", btn.dataset.tab === tab);
  });
  
  if (tab === 'lesson') {
    mainPanel.style.display = 'block';
    settingsPanel.style.display = 'none';
    setMode('daily'); // Show lesson screen inside main panel
  } else if (tab === 'review') {
    mainPanel.style.display = 'block';
    settingsPanel.style.display = 'none';
    setMode('review'); // Show review screen inside main panel
  } else if (tab === 'settings') {
    mainPanel.style.display = 'none';
    settingsPanel.style.display = 'block';
  }
}
mobileNavButtons.forEach(btn => {
  btn.onclick = () => setMobileTab(btn.dataset.tab);
});
// ===================================


uiLang.onchange = ()=>{
  state.ui = uiLang.value;
  document.documentElement.lang = state.ui==="ar"?"ar":"en";
  document.documentElement.dir = state.ui==="ar"?"rtl":"ltr";
}
exerciseLang.onchange = ()=>{ state.exMode = exerciseLang.value; startLesson(); }

// Categories
function renderCats(){
  const btn = (name)=>`<button class="${state.cat===name?'primary':''}" data-cat="${name}">${name==='All'?'كل الفئات':name}</button>`;
  catsDiv.innerHTML = btn("All")+CATS.map(c=>btn(c)).join("");
  catsDiv.querySelectorAll("button").forEach(b=>b.onclick = ()=>{ state.cat=b.dataset.cat; startLesson(); renderCats(); });
}
renderCats();

function shuffle(a){ return a.map(x=>[Math.random(), x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

// --- NEW: Efficient pickPool function (doesn't shuffle 10,000 items) ---
function pickPool(){
  let sourcePool = DATA;
  // Use the *unique* sentences if filtering by category
  if(state.cat!=="All") {
     sourcePool = uniqueSentences.filter(x=>x.cat===state.cat);
  } else {
     sourcePool = DATA; // Use the full 10k pool if "All"
  }
  
  // Don't shuffle the whole 10,000 array.
  // Just pick random items from the source pool.
  let lessonPool = [];
  const lessonSize = state.goal * 2; // e.g., 40 exercises
  for(let i=0; i < lessonSize; i++) {
    lessonPool.push(sourcePool[Math.floor(Math.random() * sourcePool.length)]);
  }
  return lessonPool; // This is already shuffled by nature of picking randomly.
}

function startLesson(){
  state.order = pickPool();
  state.idx = 0;
  updateHeader();
  nextQuestion();
  
  // --- NEW: On mobile, ensure the "lesson" tab is active when starting
  if (window.innerWidth < 900) {
    setMobileTab('lesson');
  }
}
btnStart.onclick = startLesson;

function nextQuestion(){
  resEl.textContent=""; hintEl.textContent="";
  mcEl.classList.add("hidden"); typingEl.classList.add("hidden");
  if(state.idx >= state.order.length){ 
    qEl.textContent = "انتهى الدرس! رائع 👏"; 
    state.currentQuestionText = "";
    state.currentLang = "";
    return; 
  }

  const pair = state.order[state.idx];
  const dir = decideDir();
  catTag.textContent = pair.cat;
  
  let isTyping = Math.random() < 0.8; // 80% focus on writing
  if(dir==="ar2en") isTyping = true; // Always writing for Ar -> En
  
  const question = dir==="en2ar"? pair.en : pair.ar;
  
  // --- NEW: Word-for-Word Hover feature ---
  const currentDict = (dir === "en2ar") ? MINI_DICT_EN_AR : MINI_DICT_AR_EN;
  qEl.innerHTML = question.split(' ').map(w_raw => {
    // Clean the word of punctuation for lookup
    const w_clean = w_raw.toLowerCase().replace(/[.,!?'"“”]/g, '');
    const translation = currentDict[w_clean] || "؟؟؟"; // Find translation or show '???'
    return `<span class="hover-word" title="${translation}">${w_raw}</span>`;
  }).join(' ');

  // --- Store text for speak-on-click ---
  state.currentQuestionText = question;
  state.currentLang = (dir === "en2ar") ? 'en-US' : 'ar-SA';
  
  // --- REMOVED: Automatic speech ---
  // speak(state.currentQuestionText, state.currentLang);
  // ---

  hintEl.textContent = dir==="en2ar"? "ترجم إلى العربية" : "ترجم إلى الإنجليزية";

  if(isTyping){
    typingEl.classList.remove("hidden");
    ansEl.value=""; ansEl.focus();
    btnCheck.onclick = ()=>{
      const user = ansEl.value.trim();
      const correct = dir==="en2ar"? pair.ar : pair.en;
      
      if(equalLoose(user, correct)){
        resEl.innerHTML = "✅ صحيح";
        state.xp += 5; updateHeader();
        state.idx++; setTimeout(nextQuestion, 700);
      }else{
        resEl.innerHTML = "❌ خطأ<br><span class='muted'>الإجابة الصحيحة: </span>"+correct;
        saveWrong(pair, dir);
      }
    };
    btnHint.onclick = ()=>{ hintEl.textContent = "تلميح: "+(dir==="en2ar"? pair.ar : pair.en).slice(0, Math.ceil((dir==="en2ar"? pair.ar : pair.en).length/3))+"..." }
  }else{
    // Multiple Choice Fallback
    mcEl.classList.remove("hidden");
    const correct = dir==="en2ar"? pair.ar : pair.en;
    const opts = [correct];
    
    // --- NEW: Efficient logic for distractors (doesn't shuffle 10,000 items) ---
    while(opts.length < 4) {
      const randomPair = DATA[Math.floor(Math.random() * DATA.length)];
      const o = dir==="en2ar"? randomPair.ar : randomPair.en;
      if (o !== correct && !opts.includes(o)) {
        opts.push(o);
      }
    }
    shuffle(opts); // Shuffle the final 4 options. This is fast.
    
    mcEl.innerHTML = opts.map(o=>`<div class="choice">${o}</div>`).join("");
    
    mcEl.querySelectorAll(".choice").forEach(ch=>{
      ch.onclick = ()=>{
        if(ch.textContent===correct){
          ch.classList.add("correct"); resEl.textContent="✅ صحيح"; state.xp+=5; updateHeader();
          setTimeout(()=>{ state.idx++; nextQuestion(); }, 500);
        }else{
          ch.classList.add("wrong"); resEl.innerHTML = "❌ خطأ";
          saveWrong(pair, dir);
        }
      };
    });
    btnCheck.onclick = ()=>{}; // not used
    btnHint.onclick = ()=>{ hintEl.textContent = "التوافق: "+(dir==="en2ar"? pair.en : pair.ar); }
  }
  btnSkip.onclick = ()=>{ state.idx++; nextQuestion(); };
}

function decideDir(){
  if(state.exMode==="en2ar") return "en2ar";
  if(state.exMode==="ar2en") return "ar2en";
  return Math.random()<0.5? "en2ar":"ar2en";
}
function equalLoose(a,b){
  const clean = s=>s.toLowerCase().replace(/[^\p{Letter}\p{Number}\s]/gu,"").replace(/\s+/g," ").trim();
  return clean(a)===clean(b);
}

// Review practice
el("btnPracticeWrong").onclick = ()=>{
  if(state.wrong.length===0){ alert("لا توجد أخطاء للمراجعة."); return; }
  state.order = shuffle(state.wrong.map(w=>w.pair));
  state.idx = 0;
  setMode("daily");
  nextQuestion();
  
  // --- NEW: On mobile, ensure the "lesson" tab is active
  if (window.innerWidth < 900) {
    setMobileTab('lesson');
  }
};

// Initial
ensureStreak();
updateHeader();

// --- NEW: Set initial mobile tab ---
if (window.innerWidth < 900) {
    setMobileTab('lesson');
}

</script>
</body>
</html>
